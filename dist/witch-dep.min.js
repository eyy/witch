!function(a){"object"==typeof exports?module.exports=a(require("jquery"),require("rivets"),require("watchjs")):"function"==typeof define&&define.amd?define("witch",["jquery","rivets","watch"],a):window.witch=a($||jQuery,rivets,WatchJS)}(function(a,b,c){if(!a)return console.error("Witch: where is jQuery?");if(!b)return console.error("Witch: where is Rivets?");if(!c)return console.error("Witch: where is WatchJS?");var d=function(a){return function(b,c,d){c=c.split("."),a(b,c[0],d,c.length-1)}},e=function(a,b,c){if(!b)return a;for(var d=b.split(".");d.length>1&&(a=a[d.shift()],void 0!=a););return 2===arguments.length?a[d.shift()]:(a[d.shift()]=c,void 0)};b.configure({adapter:{subscribe:d(c.watch),unsubscribe:d(c.unwatch),read:e,publish:e},handler:function(b,c,d){return a(b).data("default")||c.preventDefault(),this.call(d.model,d)}});var f=function(b,c,d,e,f){return d=d?"get"==b?a.param(d):JSON.stringify(d):null,a.ajax({type:b,url:c,data:d,success:e,dataType:"json",processData:!1,contentType:"application/json",context:f})},g=function(a,b){this._collection=b||this._collection,this._callback=this._callback.bind(this),this.update(a)};g.prototype={_parse:function(a){return a},_callback:function(b){b=this._parse(b),!this._id&&b._id&&this._collection&&(this._collection.byId[b._id]=this),a.extend(this,b)},_clean:function(){var a;for(a in this)this.hasOwnProperty(a)&&"_"!=a[0]&&(this[a]="")},toJSON:function(){var a,b={};for(a in this)this.hasOwnProperty(a)&&"_"!=a[0]&&(b[a]=this[a]);return b},fetch:function(a){return f("get",this._url+this._id,a,this._callback)},save:function(){return f(this._id?"put":"post",this._url+this._id,this,this._callback)},saveAs:function(){var a=this.toJSON();return this._clean(),this._collection.push(a).save()},"delete":function(){return this._id?f("delete",this._url+this._id,{},function(){this._clean(),this._destroyed=!0},this):(this._clean(),this._destroyed=!0,void 0)},update:function(b){return a.extend(this,this._parse(b)),this}};var h=function(a,b,c){"string"==typeof b&&(c=b,b=null),this.model=b||this.model||g,this.url=c||this.url||this.model.prototype._url,this.clean(),a&&this.push(a)};h.prototype={clean:function(){return this.list=[],this.byId={},this},fetch:function(a){return f("get",this.url,a,function(a){this.push(a)}.bind(this))},push:function(a){return Array.isArray(a)?(a.forEach(this.push.bind(this)),this.filled=!0,!1):this.byId[a._id]?this.byId[a._id].update(a):(a=a instanceof g?a:new this.model(a,this),a._collection=this,a._url||(a._url=this.url),this.filled&&(a._new=!0),c.watch(a,"_destroyed",function(b,c,d){d&&this.remove(a)}.bind(this)),a._id&&(this.byId[a._id]=a),this.list.push(a),a)},remove:function(a){var b=this.list.indexOf(a);-1!==b&&this.list.splice(b,1),delete this.byId[a._id],c.callWatchers(this)}};var i=function(b,c){this.template||(this.template=c),this.data=a.extend({},this.data,b),this.data.tpl=this};i.prototype={render:function(a){return this.template?(arguments.length||(a=this.ready),j.config.template(this.template,this.data,function(c,d){this.el=d,this._rivets=b.bind(this.el,this.data),a&&a.call(this)}.bind(this)),this):console.error("No template",this)}};var j={Model:g,Collection:h,Template:i,rest:f,config:{auto:!0,template:function(b,c,d){var e=a(a('[data-template="'+b+'"]').html().trim());d(!e.length,e)}},init:function(){a("[data-rivets]").each(function(){var c=a(this),d=window[c.data("rivets")];d&&!d._rivets&&(d._rivets=b.bind(c,d))})},inherit:function(){var b=Array.prototype.slice.call(arguments),c=b[0],d=function(){c.apply(this,arguments)};return b.unshift(d),a.extend.apply(this,b.map(function(a){return"function"==typeof a?a.prototype:a})),d}};return a(function(){j.config.auto&&j.init()}),j});