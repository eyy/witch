!function(){var a=function(a){return function(b,c,d){c=c.split("."),a(b,c[0],d,c.length-1)}},b=function(a,b,c){if(!b)return a;for(var d=b.split(".");d.length>1&&(a=a[d.shift()],void 0!=a););return 2===arguments.length?a[d.shift()]:(a[d.shift()]=c,void 0)};rivets.configure({adapter:{subscribe:a(watch),unsubscribe:a(unwatch),read:b,publish:b},handler:function(a,b,c){return $(a).data("default")||b.preventDefault(),this.call(c.model,c)}})}(),function(){var a=[].slice,b=function(a,b,c,d,e){return c=c?"get"==a?$.param(c):JSON.stringify(c):null,$.ajax({type:a,url:b,data:c,success:d,dataType:"json",processData:!1,contentType:"application/json",context:e})},c=function(a,b){this._collection=b||this._collection,this._callback=this._callback.bind(this),this.update(a)};c.prototype={_parse:function(a){return a},_callback:function(a){a=this._parse(a),!this._id&&a._id&&this._collection&&(this._collection.byId[a._id]=this),$.extend(this,a)},_clean:function(){var a;for(a in this)this.hasOwnProperty(a)&&"_"!=a[0]&&(this[a]="")},toJSON:function(){var a,b={};for(a in this)this.hasOwnProperty(a)&&"_"!=a[0]&&(b[a]=this[a]);return b},fetch:function(a){return b("get",this._url+this._id,a,this._callback)},save:function(){return b(this._id?"put":"post",this._url+this._id,this,this._callback)},saveAs:function(){var a=this.toJSON();return this._clean(),this._collection.push(a).save()},"delete":function(){return this._id?b("delete",this._url+this._id,{},function(){this._clean(),this._destroyed=!0},this):(this._clean(),this._destroyed=!0,void 0)},update:function(a){return $.extend(this,this._parse(a)),this}};var d=function(a,b,d){"string"==typeof b&&(d=b,b=null),this.model=b||this.model||c,this.url=d||this.url||this.model.prototype._url,this.clean(),a&&this.push(a)};d.prototype={clean:function(){return this.list=[],this.byId={},this},fetch:function(a){return b("get",this.url,a,function(a){this.push(a)}.bind(this))},push:function(a){return Array.isArray(a)?(a.forEach(this.push.bind(this)),this.filled=!0,!1):this.byId[a._id]?this.byId[a._id].update(a):(a=a instanceof c?a:new this.model(a,this),a._collection=this,a._url||(a._url=this.url),this.filled&&(a._new=!0),watch(a,"_destroyed",function(b,c,d){d&&this.remove(a)}.bind(this)),a._id&&(this.byId[a._id]=a),this.list.push(a),a)},remove:function(a){var b=this.list.indexOf(a);-1!==b&&this.list.splice(b,1),delete this.byId[a._id],callWatchers(this)}};var e=function(a,b){this.template||(this.template=b),this.data=$.extend({},this.data,a),this.data.tpl=this};e.prototype={render:function(a){return this.template?(a||(a=this.ready),witch.config.template(this.template,function(b,c){this.el=c,this._rivets=rivets.bind(this.el,this.data),a&&a.call(this)}.bind(this)),this):console.error("No template",this)}},window.witch={Model:c,Collection:d,Template:e,rest:b,config:{auto:!0,template:function(a,b){var c=$($('[data-template="'+a+'"]').html().trim());b(!c.length,c)}},init:function(){$("[data-rivets]").each(function(){var a=$(this),b=window[a.data("rivets")];b&&!b._rivets&&(b._rivets=rivets.bind(a,b))})},inherit:function(){var b=a.call(arguments),c=b[0],d=function(){c.apply(this,arguments)};return b.unshift(d),$.extend.apply(this,b.map(function(a){return"function"==typeof a?a.prototype:a})),d}},$(function(){witch.config.auto&&witch.init()})}();